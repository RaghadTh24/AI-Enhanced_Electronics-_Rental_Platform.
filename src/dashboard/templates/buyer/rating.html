{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% trans "Rate Device" %} | RentTech</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background-color: #f7f1eb;
    }
    .rating-container {
      max-width: 600px;
      margin: 50px auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    .device-img {
      max-width: 200px;
      margin-bottom: 20px;
    }
    .form-control {
      margin-bottom: 15px;
    }
    .btn-brown {
      background-color: #826950;
      color: white;
    }
    .btn-brown:hover {
      background-color: #6e5844;
    }
  </style>
</head>
<body>

<div class="rating-container">
  <h3>{% trans "Rate Your Device" %}</h3>
  <img class="device-img" src="{{ device.image.url }}" alt="{% trans 'Device Image' %}">

  <textarea id="userComment" class="form-control" rows="3" placeholder="{% trans 'Write your comment here' %}"></textarea>
  <input type="number" id="userStars" class="form-control" placeholder="{% trans 'Rating from 1 to 5' %}" min="1" max="5">

  <button class="btn btn-brown w-100" onclick="submitRating()">{% trans "Submit Rating" %}</button>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitRating() {
    const comment = document.getElementById("userComment").value.trim();
    const stars = parseFloat(document.getElementById("userStars").value);

    if (!comment || isNaN(stars) || stars < 1 || stars > 5) {
      alert("{% trans 'Please fill all fields correctly.' %}");
      return;
    }

    fetch("/dashboard/submit_review/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({
        comment: comment,
        stars: stars,
        device_id: {{ device.id }}
      })
    })
    .then(response => {
      if (!response.ok) throw new Error("Failed to submit rating.");
      return response.json();
    })
    .then(result => {
      alert("{% trans 'Thank you! Your rating has been submitted.' %}");
      window.location.href = "{% url 'dashboard:my_rentals' %}";
    })
    .catch(error => {
      alert("{% trans 'An error occurred. Please try again.' %}");
      console.error(error);
    });
  }
</script>

</body>
</html>