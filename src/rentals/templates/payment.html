{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment - RentTech</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      background-color: #fffaf5;
    }
    .payment-card {
      max-width: 600px;
      margin: 50px auto;
      padding: 30px;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #map {
      height: 300px;
      border-radius: 10px;
    }
    .btn-brown {
      background-color: #5e4633;
      color: white;
    }
    .btn-brown:hover {
      background-color: #4d3a28;
    }
    .apple-pay-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .apple-pay-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="payment-card">
      <h2 class="text-center mb-4">Complete Your Payment</h2>

      <p><strong>Rental Days:</strong> {{ rental_days }}</p>
      <p><strong>Total Amount:</strong> {{ device.price_per_day|floatformat:2|add:"0"|floatformat:2|stringformat:"s"|add:":" }} {{ device.price_per_day|floatformat:2 }} × {{ rental_days }} = {{ device.price_per_day|floatformat:2|add:"0"|floatformat:2|stringformat:"s"|add:":" }} SAR</p>

      <form id="paymentForm" method="POST" action="{% url 'rentals:confirm_rental' device.id %}">
        {% csrf_token %}
        <input type="hidden" name="rental_days" value="{{ rental_days }}">
        <input type="hidden" name="payment_method" id="paymentMethodInput" value="Cash">
        <input type="hidden" name="lat" id="latInput">
        <input type="hidden" name="lng" id="lngInput">

        <div class="mb-3">
          <label for="paymentMethod" class="form-label">Choose Payment Method</label>
          <select id="paymentMethod" class="form-select">
            <option value="Cash">Cash</option>
            <option value="Apple Pay">Apple Pay</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="map" class="form-label">Choose Your Location on Map:</label>
          <div id="map"></div>
          <input type="text" id="locationCoords" class="form-control mt-2" readonly placeholder="Selected location will appear here">
        </div>

        <div class="text-center">
          <button type="button" class="btn btn-brown px-4 py-2 w-100" onclick="handleSubmit()">Confirm & Pay</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Apple Pay Modal -->
  <div class="apple-pay-modal" id="applePayModal">
    <div class="apple-pay-content">
      <h5>Apple Pay Checkout</h5>
      <p>Enter your Apple Pay info (mock)</p>
      <input type="text" placeholder="Card Number" class="form-control mb-2">
      <input type="text" placeholder="Expiry" class="form-control mb-2">
      <input type="text" placeholder="CVV" class="form-control mb-3">
      <button class="btn btn-brown w-100" onclick="submitApplePay()">Pay</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([21.3891, 39.8579], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    map.on('click', function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng).addTo(map);
      }
      document.getElementById('latInput').value = lat;
      document.getElementById('lngInput').value = lng;
      document.getElementById('locationCoords').value = `${lat}, ${lng}`;
    });

    // Handle Payment Method
    document.getElementById('paymentMethod').addEventListener('change', function () {
      document.getElementById('paymentMethodInput').value = this.value;
    });

    function handleSubmit() {
      const paymentMethod = document.getElementById('paymentMethod').value;
      if (paymentMethod === 'Apple Pay') {
        document.getElementById('applePayModal').classList.add('d-flex');
      } else {
        document.getElementById('paymentForm').submit();
      }
    }


    function submitApplePay() {
      document.getElementById('applePayModal').style.display = 'none';
      document.getElementById('paymentForm').submit();
    }
  </script>
</body>
</html>
